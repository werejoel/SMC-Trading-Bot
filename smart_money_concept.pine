//@version=5
indicator("Smart Money Concept Analysis", overlay=true)

// Input parameters
var showEMA = input.bool(true, "Show EMAs")
var showSupplyDemand = input.bool(true, "Show Supply/Demand Zones")
var showOrderBlocks = input.bool(true, "Show Order Blocks")
var showLiquidity = input.bool(true, "Show Liquidity Zones")
var lookback = input.int(10, "Lookback Period", minval=1)
var thresholdPct = input.float(0.5, "Liquidity Zone Threshold %", minval=0.1, step=0.1)

// Chart type selection
chartType = input.string("Candles", "Chart Type", options=["Candles", "Hollow Candles", "Bars", "Line", "Area"])

// Colors
var color colorBullish = color.new(#089981, 0)    // Forest green for bullish
var color colorBearish = color.new(#f23645, 0)    // Crimson red for bearish
var color colorEMA20 = color.new(#2962ff, 10)     // Royal blue for EMA 20
var color colorEMA50 = color.new(#9c27b0, 10)     // Purple for EMA 50
var color colorEMA200 = color.new(#ff6d00, 10)    // Orange for EMA 200
var color colorLiquidity = color.new(#131722, 80)  // Dark gray for liquidity zones

// Plot Price Panel based on selected type
if chartType == "Candles"
    plotcandle(open, high, low, close, 
        title="Candlesticks",
        color = close >= open ? colorBullish : colorBearish,
        wickcolor = close >= open ? colorBullish : colorBearish,
        bordercolor = close >= open ? colorBullish : colorBearish)

else if chartType == "Hollow Candles"
    plotcandle(open, high, low, close, 
        title="Hollow Candlesticks",
        color = close >= open ? color.new(colorBullish, 100) : color.new(colorBearish, 100),
        wickcolor = close >= open ? colorBullish : colorBearish,
        bordercolor = close >= open ? colorBullish : colorBearish)

else if chartType == "Bars"
    plot(high, "High", style=plot.style_circles, color=color.new(colorBullish, 0), linewidth=2)
    plot(low, "Low", style=plot.style_circles, color=color.new(colorBearish, 0), linewidth=2)
    plot(close, "Close", style=plot.style_line, color=color.new(#131722, 0), linewidth=2)

else if chartType == "Line"
    plot(close, "Price", color=color.new(#131722, 0), linewidth=2, style=plot.style_line)

else if chartType == "Area"
    plot(close, "Price", color=color.new(#131722, 70), linewidth=2, style=plot.style_area)

// Moving Averages
float ema20 = ta.ema(close, 20)
float ema50 = ta.ema(close, 50)
float ema200 = ta.ema(close, 200)

// Plot EMAs
plot(showEMA ? ema20 : na, "EMA 20", color=colorEMA20, linewidth=2)
plot(showEMA ? ema50 : na, "EMA 50", color=colorEMA50, linewidth=2)
plot(showEMA ? ema200 : na, "EMA 200", color=colorEMA200, linewidth=2)

// Trend Analysis
bool bullishTrend = ema20 > ema50 and ema50 > ema200
bool bearishTrend = ema20 < ema50 and ema50 < ema200

// Plot trend labels
if bullishTrend
    label.new(bar_index, high, "Bullish Trend", 
        color=colorBullish, 
        style=label.style_label_down, 
        textcolor=color.white)

if bearishTrend
    label.new(bar_index, low, "Bearish Trend", 
        color=colorBearish, 
        style=label.style_label_up, 
        textcolor=color.white)

// Liquidity Zone Detection
float swingHigh = ta.pivothigh(high, lookback, lookback)
float swingLow = ta.pivotlow(low, lookback, lookback)

// Calculate threshold based on average price
float avgPrice = ta.sma(close, lookback)
float threshold = avgPrice * thresholdPct / 100

// Plot Liquidity Zones
if showLiquidity
    if not na(swingHigh)
        float swingStrength = math.abs(high - ta.valuewhen(swingHigh, high, 1)) / avgPrice * 100
        if swingStrength > thresholdPct
            line.new(bar_index[lookback], swingHigh, bar_index, swingHigh, 
                color=colorLiquidity, 
                style=line.style_dashed)
            label.new(bar_index, swingHigh, "Liquidity High", 
                style=label.style_label_down, 
                color=color.new(colorLiquidity, 50), 
                textcolor=colorLiquidity,
                size=size.small)

    if not na(swingLow)
        float swingStrength = math.abs(low - ta.valuewhen(swingLow, low, 1)) / avgPrice * 100
        if swingStrength > thresholdPct
            line.new(bar_index[lookback], swingLow, bar_index, swingLow, 
                color=colorLiquidity, 
                style=line.style_dashed)
            label.new(bar_index, swingLow, "Liquidity Low", 
                style=label.style_label_up, 
                color=color.new(colorLiquidity, 50), 
                textcolor=colorLiquidity,
                size=size.small)

// Supply/Demand Zone Detection
bool isStrongBearish = close < open and (open - close) > (high - low) * 0.4
bool isStrongBullish = close > open and (close - open) > (high - low) * 0.4

// Plot Supply/Demand Zones
if showSupplyDemand
    if isStrongBearish
        box.new(bar_index, high, bar_index + lookback, open, 
            border_color=colorBearish, 
            bgcolor=color.new(colorBearish, 90), 
            text="Supply")
    if isStrongBullish
        box.new(bar_index, close, bar_index + lookback, low, 
            border_color=colorBullish, 
            bgcolor=color.new(colorBullish, 90), 
            text="Demand")

// Alert conditions
alertcondition(bullishTrend and isStrongBullish, "Bullish Setup", "Strong bullish setup in uptrend")
alertcondition(bearishTrend and isStrongBearish, "Bearish Setup", "Strong bearish setup in downtrend")
alertcondition(not na(swingHigh), "Liquidity High Formed", "New swing high liquidity zone formed")
alertcondition(not na(swingLow), "Liquidity Low Formed", "New swing low liquidity zone formed") 